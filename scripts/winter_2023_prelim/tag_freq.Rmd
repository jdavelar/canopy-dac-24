---
title: "Tag Frequency Changes"
author: "Janette Avelar"
date: '2023-12-16'
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    highlight: tango
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warnings = FALSE, message = FALSE)
pacman::p_load(tidyverse, here, rio, DT, ggcorrplot, psych, parameters)
#read in data
dat <- import(here("data/longitudinal", "tags-long.csv"))
#read in tag labels
labels <- import(here("data", "tag_labels.csv"))
```

# Across schools

*Central Q: * For each practice where we have at least 2 years of data, how has the practice's frequency changed?  
-look only at changes within schools - so, schools that have at least 2 data points about that practice
-the object of inquiry here is the practice - how have each practice's frequencies changed?

A few ideas:  
-could be a table showing +/-X (where X is number of schools adding or removing) for each year. We did a graph version of this on p.8 in the 2021 report.  
-could be a line graph showing # of schools reporting each practice each year, similar to p.22 in the 2022 report. (Note, this code should be in our github from 2022.)  
-to make it more readable, it could be interactive (user could hover over a tag to see that line distinguished).  

### Raw Counts Table

```{r}
##### creating table with raw count differences across years #####
#starting with raw counts for each year
dat %>% 
  group_by(year, var) %>% 
  summarize(n = sum(usage, na.rm = TRUE)) %>% 
  #need to also figure out how many repeat over year
  ungroup() %>% 
  mutate(rate = rep(1, nrow(.))) %>% 
  group_by(var) %>% 
  mutate(rep = sum(rate, na.rm = TRUE)) %>% 
  ungroup() %>% 
  #drop vars without 2+ years of data
  filter(rep > 1) %>% 
  select(!c(rate, rep)) %>% 
  #make cols for each year to determine change
  pivot_wider(names_from = year,
              values_from = n) %>% 
  #calculate change
  mutate(change_2021 = `2021` - `2019`,
         change_2022 = `2022` - `2021`,
         change_2023 = `2023` - `2022`) %>% 
  #bring in labels
  left_join(labels, by = "var") %>% 
  select(Tag = label, `2019`, `2021` = change_2021, `2022` = change_2022, `2023` = change_2023) %>% 
  #table
  datatable() %>%
  #style
  formatStyle(columns = c("2021", "2022", "2023"), 
              color = styleInterval(cuts = 0, values = c("red", "green")),
              textAlign = "center")
```

### Percentage Table

```{r}
##### creating table with percentage differences across years #####
#year totals
totals <- dat %>% 
  select(school_id, year) %>% 
  unique() %>% 
  mutate(rate = rep(1, nrow(.))) %>% 
  group_by(year) %>% 
  summarize(n_school = sum(rate, na.rm = TRUE)) %>% 
  ungroup()
# create table with percentage changes
dat %>% 
  group_by(year, var) %>% 
  summarize(n = sum(usage, na.rm = TRUE)) %>% 
  left_join(totals, by = "year") %>% 
  mutate(pct = n/n_school,
         rate = rep(1, n())) %>% 
  ungroup() %>% 
  #need to also figure out how many repeat over year
  group_by(var) %>% 
  mutate(rep = sum(rate, na.rm = TRUE)) %>% 
  ungroup() %>% 
  #drop vars without 2+ years of data
  filter(rep > 1) %>% 
  select(var, year, pct) %>% 
  #make cols for each year
  pivot_wider(names_from = year,
              values_from = pct) %>%
  #calculate change
  mutate(change_2021 = `2021` - `2019`,
         change_2022 = `2022` - `2021`,
         change_2023 = `2023` - `2022`) %>% 
  #bring in labels
  left_join(labels, by = "var") %>% 
  select(Tag = label, `2019`, `2021` = change_2021, `2022` = change_2022, `2023` = change_2023) %>% 
  #table
  datatable() %>%
  #style
  formatStyle(columns = c("2021", "2022", "2023"), 
              color = styleInterval(cuts = 0, values = c("red", "green")),
              textAlign = "center") %>% 
  formatPercentage(c("2019", "2021", "2022", "2023"), 0)
```



# Within Schools

*Central Q: * For each practice where we have at least 2 years of data, how has the practice's frequency changed?  
-look only at changes within schools - so, schools that have at least 2 data points about that practice
-the object of inquiry here is the practice - how have each practice's frequencies changed?

A few ideas:  
-could be a table showing +/-X (where X is number of schools adding or removing) for each year. We did a graph version of this on p.8 in the 2021 report.  
-could be a line graph showing # of schools reporting each practice each year, similar to p.22 in the 2022 report. (Note, this code should be in our github from 2022.)  
-to make it more readable, it could be interactive (user could hover over a tag to see that line distinguished).  

### Raw Counts Table - 2 year tags

This table displays the raw count differences across years for tags that appear in 2 years of data.


```{r}
##### creating table with raw count differences across years #####
#starting with raw counts for each year
n_dat <- dat %>% 
  mutate(n_year_tag = n_distinct(year), .by = var) %>% 
  mutate(n_year_schl = n_distinct(year), .by = school_id)

# 2 year tags
#overall view table
overall_2yr <-
n_dat %>% 
  filter(n_year_tag == 2) %>% 
  # mutate(n = sum(usage), .by = c(year, var)) %>% 
  filter(n_year_schl > 2) %>% 
  select(-n_year_tag, -n_year_schl) %>% 
  # group_by(year, var) %>% 
  # summarize(n = sum(usage, na.rm = TRUE)) %>% 
  #make cols for each year to determine change
  pivot_wider(names_from = year,
              values_from = usage) %>% 
  #calculate change
  group_by(school_id, var) %>% 
  mutate(change_2021 = `2021` - `2019`,
         change_2022 = `2022` - `2021`,
         change_2023 = `2023` - `2022`,
         added_2021 = ifelse(change_2021 == 1, 1, 0),
         added_2022 = ifelse(change_2022 == 1, 1, 0),
         added_2023 = ifelse(change_2023 == 1, 1, 0),
         drop_2021 = ifelse(change_2021 == -1, 1, 0),
         drop_2022 = ifelse(change_2022 == -1, 1, 0),
         drop_2023 = ifelse(change_2023 == -1, 1, 0)) %>% 
  ungroup() %>% 
  group_by(var) %>% 
  summarize(`2019` = sum(`2019`, na.rm = TRUE),
            `2021` = sum(change_2021, na.rm = TRUE),
            `2022` = sum(change_2022, na.rm = TRUE),
            `2023` = sum(change_2023, na.rm = TRUE),
            `2021 adds` = sum(added_2021, na.rm = TRUE),
            `2022 adds` = sum(added_2022, na.rm = TRUE),
            `2023 adds` = sum(added_2023, na.rm = TRUE),
            `2021 drops` = sum(drop_2021, na.rm = TRUE),
            `2022 drops` = sum(drop_2022, na.rm = TRUE),
            `2023 drops` = sum(drop_2023, na.rm = TRUE)) %>% 
  mutate(across(`2019`:`2023 drops`, ~na_if(., 0))) %>% 
  #bring in labels
  left_join(labels, by = "var")

#overview table
overall_2yr %>% 
  select(Tag = label, `2019`, `2021`, `2022`, `2023`) %>% 
  #table
  datatable() %>%
  #style
  formatStyle(columns = c("2021", "2022", "2023"), 
              color = styleInterval(cuts = 0, values = c("red", "green")),
              textAlign = "center")
```

This table breaks down the raw count for 2-year tags, by displaying the number of adds and drops in each year.


```{r}
#adds and drops table
overall_2yr %>% 
  select(Tag = label, ends_with("adds"), ends_with("drops")) %>% 
  mutate(across(ends_with("drops"), ~.*-1)) %>% 
  mutate(across(`2021 adds`:`2023 drops`, ~na_if(., 0))) %>% 
  #table
  datatable() %>%
  #style
  formatStyle(columns = c("2021 adds", "2022 adds", "2023 adds", "2021 drops", "2022 drops", "2023 drops"), 
              color = styleInterval(cuts = 0, values = c("red", "green")),
              textAlign = "center")
```

### Raw Counts Table - 3 year tags

This table displays the raw count differences across years for tags that appear in 3 years of data.

```{r}
# 3 year tags
#overall view table
overall_3yr <-
n_dat %>% 
  filter(n_year_tag == 3) %>% 
  # mutate(n = sum(usage), .by = c(year, var)) %>% 
  filter(n_year_schl > 3) %>% 
  select(-n_year_tag, -n_year_schl) %>% 
  # group_by(year, var) %>% 
  # summarize(n = sum(usage, na.rm = TRUE)) %>% 
  #make cols for each year to determine change
  pivot_wider(names_from = year,
              values_from = usage) %>% 
  #calculate change
  group_by(school_id, var) %>% 
  mutate(change_2021 = `2021` - `2019`,
         change_2022 = `2022` - `2021`,
         change_2023 = `2023` - `2022`,
         added_2021 = ifelse(change_2021 == 1, 1, 0),
         added_2022 = ifelse(change_2022 == 1, 1, 0),
         added_2023 = ifelse(change_2023 == 1, 1, 0),
         drop_2021 = ifelse(change_2021 == -1, 1, 0),
         drop_2022 = ifelse(change_2022 == -1, 1, 0),
         drop_2023 = ifelse(change_2023 == -1, 1, 0)) %>% 
  ungroup() %>% 
  group_by(var) %>% 
  summarize(`2019` = sum(`2019`, na.rm = TRUE),
            `2021` = sum(change_2021, na.rm = TRUE),
            `2022` = sum(change_2022, na.rm = TRUE),
            `2023` = sum(change_2023, na.rm = TRUE),
            `2021 adds` = sum(added_2021, na.rm = TRUE),
            `2022 adds` = sum(added_2022, na.rm = TRUE),
            `2023 adds` = sum(added_2023, na.rm = TRUE),
            `2021 drops` = sum(drop_2021, na.rm = TRUE),
            `2022 drops` = sum(drop_2022, na.rm = TRUE),
            `2023 drops` = sum(drop_2023, na.rm = TRUE)) %>% 
  mutate(across(`2019`:`2023 drops`, ~na_if(., 0))) %>% 
  #bring in labels
  left_join(labels, by = "var")

#overview table
overall_3yr %>% 
  select(Tag = label, `2019`, `2021`, `2022`, `2023`) %>% 
  #table
  datatable() %>%
  #style
  formatStyle(columns = c("2021", "2022", "2023"), 
              color = styleInterval(cuts = 0, values = c("red", "green")),
              textAlign = "center")
```

This table breaks down the raw count for 3-year tags, by displaying the number of adds and drops in each year.

```{r}
#adds and drops table
overall_3yr %>% 
  select(Tag = label, ends_with("adds"), ends_with("drops")) %>% 
  mutate(across(ends_with("drops"), ~.*-1)) %>% 
  mutate(across(`2021 adds`:`2023 drops`, ~na_if(., 0))) %>% 
  #table
  datatable() %>%
  #style
  formatStyle(columns = c("2021 adds", "2022 adds", "2023 adds", "2021 drops", "2022 drops", "2023 drops"), 
              color = styleInterval(cuts = 0, values = c("red", "green")),
              textAlign = "center")
```

### Raw Counts Table - 4 year tags

This table displays the raw count differences across years for tags that appear in all 4 years of data.

```{r}
# 4 year tags
#overall view table
overall_4yr <-
n_dat %>% 
  filter(n_year_tag == 4) %>% 
  # mutate(n = sum(usage), .by = c(year, var)) %>% 
  filter(n_year_schl == 4) %>% 
  select(-n_year_tag, -n_year_schl) %>% 
  # group_by(year, var) %>% 
  # summarize(n = sum(usage, na.rm = TRUE)) %>% 
  #make cols for each year to determine change
  pivot_wider(names_from = year,
              values_from = usage) %>% 
  #calculate change
  group_by(school_id, var) %>% 
  mutate(change_2021 = `2021` - `2019`,
         change_2022 = `2022` - `2021`,
         change_2023 = `2023` - `2022`,
         added_2021 = ifelse(change_2021 == 1, 1, 0),
         added_2022 = ifelse(change_2022 == 1, 1, 0),
         added_2023 = ifelse(change_2023 == 1, 1, 0),
         drop_2021 = ifelse(change_2021 == -1, 1, 0),
         drop_2022 = ifelse(change_2022 == -1, 1, 0),
         drop_2023 = ifelse(change_2023 == -1, 1, 0)) %>% 
  ungroup() %>% 
  group_by(var) %>% 
  summarize(`2019` = sum(`2019`, na.rm = TRUE),
            `2021` = sum(change_2021, na.rm = TRUE),
            `2022` = sum(change_2022, na.rm = TRUE),
            `2023` = sum(change_2023, na.rm = TRUE),
            `2021 adds` = sum(added_2021, na.rm = TRUE),
            `2022 adds` = sum(added_2022, na.rm = TRUE),
            `2023 adds` = sum(added_2023, na.rm = TRUE),
            `2021 drops` = sum(drop_2021, na.rm = TRUE),
            `2022 drops` = sum(drop_2022, na.rm = TRUE),
            `2023 drops` = sum(drop_2023, na.rm = TRUE)) %>% 
  mutate(across(`2019`:`2023 drops`, ~na_if(., 0))) %>% 
  #bring in labels
  left_join(labels, by = "var")

#overview table
overall_2yr %>% 
  select(Tag = label, `2019`, `2021`, `2022`, `2023`) %>% 
  #table
  datatable() %>%
  #style
  formatStyle(columns = c("2021", "2022", "2023"), 
              color = styleInterval(cuts = 0, values = c("red", "green")),
              textAlign = "center")
```

This table breaks down the raw count for 4-year tags, by displaying the number of adds and drops in each year.

```{r}
#adds and drops table
overall_2yr %>% 
  select(Tag = label, ends_with("adds"), ends_with("drops")) %>% 
  mutate(across(ends_with("drops"), ~.*-1)) %>% 
  mutate(across(`2021 adds`:`2023 drops`, ~na_if(., 0))) %>% 
  #table
  datatable() %>%
  #style
  formatStyle(columns = c("2021 adds", "2022 adds", "2023 adds", "2021 drops", "2022 drops", "2023 drops"), 
              color = styleInterval(cuts = 0, values = c("red", "green")),
              textAlign = "center")
```

# Blended learning tags

How has the rate of blended learning tags changed each year since 2019?

For the following graph, I defined blended learning tags as those that are nested under the *blended learning* umbrella in years 23/24:  
- blended learning  
- à la carte model  
- flipped classroom  
- flex model  
- enriched virtual model  
- station rotation  

### Across schools
Graph #1 looks at selection of tags across our whole sample, i.e., the number reflects the percentage of our total sample of schools that selected each tag. (AKA across schools)

One of the questions we were hoping to investigate with this graph is whether the selection of blended learning tags may be due to changes in our survey design through the introduction of parent/child tags. We do see a sharp decrease in child tags in 2023. However, the selection for the parent tag `blended learning` remains high. All school leaders that selected `blended learning` would have received a follow-up question about the type of blended learning they use with our child tags listed below. This makes me think that schools are still using blended learning, but perhaps did not see their approach to blended learning reflected in our child tags. (So what are they using...?)

```{r}
# subset tags
blended_tags <- c("practices_blended_learning", "practices_a_la_carte", "practices_flipped_classroom", "practices_flex", "practices_enriched_virtual", "practices_station_rotation")
blended <- dat %>% 
  filter(var %in% blended_tags) %>%
  group_by(var, year) %>% 
  summarize(n = sum(usage)) %>% 
  ungroup()
tots <- dat %>% 
  group_by(year) %>% 
  summarize(total = n_distinct(school_id)) %>% 
  unique()
blended <- blended %>% 
  left_join(tots, by = "year") %>% 
  mutate(pct = n/total) %>% 
  left_join(labels, by = "var")
#build plot
#palette colors
palette <- c("#BC2582", "#FFA630","#FFDE42","#99C24D","#218380","#D3B7D7")
#labels
labs <- blended %>% 
  filter(year == 2023) %>% 
  select(label, x = year, y = pct)
#plot
blended %>% 
  ggplot(aes(year, pct, color = label)) +
  geom_point() +
  geom_line() +
  theme_bw() +
  scale_color_manual(values = palette) +
  scale_x_continuous(expand = expansion(mult = c(.025, .3))) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  theme(legend.position = "none") +
  geom_text(data = labs, 
            aes(label = label, 
                x = x, 
                y = y),
            hjust = -.05)
```

### Across schools (no COVID)

What if we omit 2021 to account for the big jump?

```{r}
blended <- dat %>% 
  filter(var %in% blended_tags) %>%
  filter(year != 2021) %>% 
  group_by(var, year) %>% 
  summarize(n = sum(usage)) %>% 
  ungroup() %>% 
  left_join(tots, by = "year") %>% 
  mutate(pct = n/total) %>% 
  left_join(labels, by = "var")

#plot
blended %>% 
  ggplot(aes(year, pct, color = label)) +
  geom_point() +
  geom_line() +
  theme_bw() +
  scale_color_manual(values = palette) +
  scale_x_continuous(expand = expansion(mult = c(.025, .3))) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  theme(legend.position = "none") +
  geom_text(data = labs, 
            aes(label = label, 
                x = x, 
                y = y),
            hjust = -.05)
```

### Within schools
Graph #2 looks at the rate of change for blended learning tags only among schools that participated for 2 or more years. (AKA within schools)

```{r}
#key for participating schools 2+ times
repeaters <- dat %>% 
  select(school_id, year) %>% 
  unique() %>% 
  mutate(rate = 1) %>% 
  pivot_wider(names_from = "year",
              values_from = "rate") %>% 
  rowwise() %>% 
  mutate(participate = sum(`2019`, `2021`, `2022`, `2023`, na.rm = TRUE)) %>% 
  filter(participate > 1) %>% 
  pull(school_id)
#data
blended <- dat %>% 
  #filter only blended tags
  filter(var %in% blended_tags) %>% 
  #filter only repeat schools
  filter(school_id %in% repeaters) %>% 
  #create wave variable
  arrange(school_id, year) %>% 
  group_by(school_id) %>%
  mutate(wave = dense_rank(year)) %>% 
  ungroup() %>% 
  #create change column
  arrange(school_id, year) %>%
  group_by(school_id, var) %>%
  mutate(change = usage - lag(usage)) %>% 
  ungroup() %>% 
  #create add/drop columns
  mutate(adds = ifelse(change == 1, 1, NA),
         drops = ifelse(change == -1, 1, NA)) %>% 
  #create totals
  group_by(var, year) %>% 
  summarize(`Overall rate` = sum(usage, na.rm = TRUE),
            `Average change` = sum(change, na.rm = TRUE),
            Adds = sum(adds, na.rm = TRUE),
            Drops = sum(drops, na.rm = TRUE)) %>% 
  ungroup() %>% 
  #pivot for plotting
  pivot_longer(cols = c(`Overall rate`, `Average change`, Adds, Drops),
               names_to = "type",
               values_to = "n") %>% 
  #labels for plotting
  left_join(labels, by = "var") %>% 
  #order for plotting
  mutate(type = factor(type, levels = c("Overall rate", "Average change", "Adds", "Drops")))

#palette for plot
palette <- c("gray80", "#f1c1af", "#6bd497", "#b94c4c")
#plot
blended %>% 
  ggplot(aes(year, n, color = type)) +
  geom_point() +
  geom_line() +
  theme_bw() +
  scale_color_manual(values = palette) +
  scale_x_continuous(expand = expansion(mult = c(.025, .3))) +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  theme(legend.position = "bottom") +
  facet_wrap(~label) +
  labs(x = "Year",
       y = "Tag selection (N)",
       color = "Rate of change")
```

### Within schools (no COVID)
Again, what if we omit 2021?

```{r}
#data
blended <- dat %>% 
  #filter only blended tags
  filter(var %in% blended_tags) %>% 
  #filter only repeat schools
  filter(school_id %in% repeaters) %>% 
  #drop 2021 year
  filter(year != 2021) %>% 
  #create wave variable
  arrange(school_id, year) %>% 
  group_by(school_id) %>%
  mutate(wave = dense_rank(year)) %>% 
  ungroup() %>% 
  #create change column
  arrange(school_id, year) %>%
  group_by(school_id, var) %>%
  mutate(change = usage - lag(usage)) %>% 
  ungroup() %>% 
  #create add/drop columns
  mutate(adds = ifelse(change == 1, 1, NA),
         drops = ifelse(change == -1, 1, NA)) %>% 
  #create totals
  group_by(var, year) %>% 
  summarize(`Overall rate` = sum(usage, na.rm = TRUE),
            `Average change` = sum(change, na.rm = TRUE),
            Adds = sum(adds, na.rm = TRUE),
            Drops = sum(drops, na.rm = TRUE)) %>% 
  ungroup() %>% 
  #pivot for plotting
  pivot_longer(cols = c(`Overall rate`, `Average change`, Adds, Drops),
               names_to = "type",
               values_to = "n") %>% 
  #labels for plotting
  left_join(labels, by = "var") %>% 
  #order for plotting
  mutate(type = factor(type, levels = c("Overall rate", "Average change", "Adds", "Drops")))

#plot
blended %>% 
  ggplot(aes(year, n, color = type)) +
  geom_point() +
  geom_line() +
  theme_bw() +
  scale_color_manual(values = palette) +
  scale_x_continuous(expand = expansion(mult = c(.025, .3))) +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  theme(legend.position = "bottom") +
  facet_wrap(~label) +
  labs(x = "Year",
       y = "Tag selection (N)",
       color = "Rate of change")
```

### 2023 Drop Investigation

Investigating drop in blended learning tags in 2023.

*From CW*: Could you do a quick tally of: 
a) how many schools in 2022 chose any of the child tags WITHOUT choosing "blended learning"

There were 21 instances where a school leader chose child tags but did not choose blended learning.

```{r}
dat %>% 
  filter(year == 2022) %>% 
  filter(var %in% blended_tags) %>% 
  pivot_wider(names_from = "var",
              values_from = "usage") %>% 
  group_by(school_id) %>% 
  mutate(children = case_when(
    practices_a_la_carte == 1 ~ 1,
    practices_flex == 1 ~ 1,
    practices_flipped_classroom == 1 ~ 1,
    practices_enriched_virtual == 1 ~ 1,
    practices_station_rotation == 1 ~ 1,
    TRUE ~ 0
  ),
  childless = case_when(
    practices_blended_learning == 1 & children == 0 ~ 1,
    TRUE ~ 0
  ),
  parentless = case_when(
    practices_blended_learning == 0 & children == 1 ~ 1,
    TRUE ~ 0
  )) %>% 
  ungroup() %>% 
  summarize(selected_children = sum(parentless),
            selected_parent_only = sum(childless)) %>% 
  datatable()
```


b) how many schools in 2023 chose "blended learning" as a parent tag but didn't choose any child tags?

There were 53 instances where a school leader chose blended learning but did not choose one of the child tags. (And 94 instances where they did choose child tags, for comparison.)

```{r}
dat %>% 
  filter(year == 2023) %>% 
  filter(var %in% blended_tags) %>% 
  pivot_wider(names_from = "var",
              values_from = "usage") %>% 
  group_by(school_id) %>% 
  mutate(children = case_when(
    practices_a_la_carte == 1 ~ 1,
    practices_flex == 1 ~ 1,
    practices_flipped_classroom == 1 ~ 1,
    practices_enriched_virtual == 1 ~ 1,
    practices_station_rotation == 1 ~ 1,
    TRUE ~ 0
  ),
  childless = case_when(
    practices_blended_learning == 1 & children == 0 ~ 1,
    TRUE ~ 0
  )) %>% 
  ungroup() %>% 
  summarize(selected_parent = sum(childless),
            selected_children = sum(children)) %>% 
  datatable()
```

