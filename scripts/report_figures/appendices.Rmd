---
title: "Supplemental Data"
#author: "Janette Avelar"
#date: '2024-11-13'
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    highlight: tango
    code_folding: none
editor_options: 
  chunk_output_type: console
knitr:
  opts_chunk:
    include: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warnings = FALSE, message = FALSE)
pacman::p_load(tidyverse, here, rio, plotly, ggthemes)
#read in data
dat <- import(here("data/longitudinal", "tags-long.csv"))
#read in tag labels
labels <- import(here("data", "tag_labels.csv"))
#read in cluster information
cluster <- import(here("data/longitudinal", "tag_clusters_longitudinal.csv")) %>% 
  janitor::clean_names()
```

```{r}
# Pull in Branding
transcend_cols = c("#1A4C81","#59C3B4","#EF464B","#ADE0EE")
transcend_cols2 = c("#BC2582","#FFA630","#FFDE42","#99C24D","#218380","#D3B7D7")
transcend_grays = c("#4D4D4F","#9D9FA2","#D1D3D4")
transcend_na = transcend_grays[2]
theme_transcend = theme_gdocs(base_size = 14, base_family = "Open Sans") +
  theme(
    plot.title = element_text(family = "Bebas Neue", color = "black"),
    plot.background = element_blank(),
    axis.text = element_text(colour = "black"),
    axis.title = element_text(colour = "black"),
    panel.border = element_rect(colour = "#4D4D4F"),
    strip.text = element_text(size = rel(0.8)),
    plot.margin = margin(10, 24, 10, 10, "pt")
  )
theme_set(theme_transcend)
```

## A. Changes in school practices over time

Lorem ipsum odor amet, consectetuer adipiscing elit. Molestie dui condimentum magnis metus eu. Tortor montes augue ac tortor nunc pretium. Hac quam nostra dapibus orci; quam maximus. Purus eleifend malesuada urna hac massa maecenas ultrices vestibulum vivamus. Condimentum taciti consectetur sem sodales; maximus duis rhoncus. Enim nisi ac lacinia taciti eu posuere finibus. Pharetra tempor sem aenean facilisis praesent. Posuere montes congue; eleifend himenaeos viverra euismod.  

Lobortis donec efficitur eu iaculis convallis. Imperdiet efficitur commodo nibh leo; sem fermentum ligula tempor. Purus praesent aliquet suspendisse per etiam. Dis ad nec adipiscing augue viverra ac? Erat vestibulum augue odio nulla interdum efficitur venenatis quisque. Elit eros curae quisque bibendum porta sit. Condimentum aliquam bibendum luctus, placerat urna nascetur.  

### Educational Justice and Holistic Student Support

Lorem ipsum odor amet, consectetuer adipiscing elit. Finibus blandit class dui sapien rutrum velit quisque. Etiam proin est ullamcorper sit elit purus nullam. Velit vel class rhoncus leo nulla neque. Vel venenatis quisque senectus maecenas proin. Libero egestas et neque lacus vivamus aptent varius maximus.  

Sodales nostra hac sagittis a quisque accumsan. Eleifend parturient phasellus cubilia mi egestas facilisis. Cras sodales erat aliquet nullam ac; mauris vulputate ad non. Hac eleifend a nullam finibus amet commodo morbi facilisis! Luctus donec curae eros elementum auctor eleifend massa. Tortor hendrerit quam cras lobortis facilisi eget consectetur. Libero felis aptent auctor sociosqu vel cubilia porta volutpat.  

Ipsum inceptos velit libero aliquet fusce nibh. Arcu diam aliquet ex ex porttitor himenaeos lacus. Dapibus et libero ultricies feugiat; torquent pellentesque et nam. Himenaeos magnis feugiat suscipit ornare class. Ad maecenas congue metus vitae risus. Ad lacinia inceptos varius quis sodales vulputate magnis metus. Ultricies aenean facilisis sit fames felis posuere eget. Facilisis sollicitudin id magna imperdiet est fermentum iaculis vivamus. Mauris facilisi vel eleifend tincidunt augue interdum.  

```{r data prep}
# start by creating cluster subsets
#subset values
deeper <- cluster %>% 
  filter(proposed_cluster_for_preliminary_24_analysis == "Deeper learning") %>% 
  select(label = tag) %>% 
  left_join(labels, by = "label") %>% 
  pull(var)
ed_justice <- cluster %>% 
  filter(proposed_cluster_for_preliminary_24_analysis == "Ed justice") %>% 
  select(label = tag) %>% 
  left_join(labels, by = "label") %>% 
  pull(var)
individualized <- cluster %>% 
  filter(proposed_cluster_for_preliminary_24_analysis == "Individualized") %>% 
  select(label = tag) %>% 
  left_join(labels, by = "label") %>% 
  pull(var)
postsecondary <- cluster %>% 
  filter(proposed_cluster_for_preliminary_24_analysis == "Postsecondary") %>% 
  select(label = tag) %>% 
  left_join(labels, by = "label") %>% 
  pull(var)
#set up repeating schools - 3+ years
repeaters_3 <- dat %>% 
  select(school_id, year) %>% 
  unique() %>% 
  mutate(rate = 1) %>% 
  pivot_wider(names_from = "year",
              values_from = "rate") %>% 
  rowwise() %>% 
  mutate(participate = sum(`2019`, `2021`, `2022`, `2023`, `2024`, na.rm = TRUE)) %>% 
  filter(participate > 2) %>% 
  pull(school_id)
# set up total
tots_3 <- dat %>% 
  filter(school_id %in% repeaters_3) %>% 
  group_by(year) %>% 
  summarize(total = n_distinct(school_id))
#set up 3+ year tags
rep_tags <- dat %>% 
  group_by(var) %>% 
  summarize(num_years = n_distinct(year)) %>% 
  ungroup() %>% 
  filter(num_years >= 3) %>% 
  select(var) %>% 
  unique() %>% 
  pull(var)
#prep data function overall pct
prep_overall <- function(data, cluster, group, total){
  dat <- data %>% 
    filter(var %in% cluster) %>% 
    filter(school_id %in% group) %>% 
    group_by(var, year) %>% 
    summarize(n = sum(usage, na.rm = TRUE)) %>% 
    ungroup() %>% 
    left_join(total, by = "year") %>% 
    mutate(pct = n/total) %>% 
    left_join(labels, by = "var") %>% 
    group_by(var) %>% 
    mutate(x_coord = max(year),
           y_coord = pct[which.max(year)])

    return(dat)
}
```

```{r branding & plot prep}
### PLOT FUNCTIONS ###
#theme function - could not load branding file
transcend_cols = c("#1A4C81","#59C3B4","#EF464B","#ADE0EE")
theme_transcend = theme_gdocs(base_size = 14, base_family = "Open Sans") +
  theme(
    plot.title = element_text(family = "Bebas Neue", color = "black"),
    plot.background = element_blank(),
    axis.text = element_text(colour = "black"),
    axis.title = element_text(colour = "black"),
    panel.border = element_rect(colour = "#4D4D4F"),
    strip.text = element_text(size = rel(0.8)),
    plot.margin = margin(10, 24, 10, 10, "pt")
  )
cluster_plot_within <- function(data, facet) { 
  plot <- ggplot(data, aes_string(x = "year", y = "n")) + 
    geom_line(aes(group = label), color = "gray", alpha = 0.5) + 
    geom_point(aes(group = label), color = "gray", alpha = 0.5, size = 1) + 
    geom_smooth(se = FALSE, method = "lm", color = "cornflowerblue", aes(group = 1)) + 
    theme_bw() +
    scale_x_continuous(name = "Year", expand = expansion(mult = c(.025, .3))) +
    theme(panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(), legend.position = "none") +
    facet_wrap(as.formula(paste0("~", facet))) +
    theme_transcend

  return(plot)
}
#fancy plot - plotly
fancy_across <- function(data, title){
  
  key <- highlight_key(data, ~label) 
  
  plot <- plot_ly(key,
        x = ~year, 
        y = ~pct, 
        type = 'scatter', 
        mode = 'lines+markers', 
        color = I(transcend_cols[1]),
        marker = list(size = 5),
        text = ~label,
        hoverinfo = 'text+y',
        showlegend = FALSE
      )
  
  # Apply layout and highlight after adding all traces
  plot <- plot %>%
    layout(
      title = list(
        text = title,
        font = list(size = 25, color = "black", family = "Bebas Neue"),
        x = 0,
        xanchor = "left"
      ),
      yaxis = list(
        title = list(
          text = "Percentage of schools selecting tag",
          font = list(size = 16, color = "black", family = "Open Sans")
        ),
        tickfont = list(size = 12, color = "black", family = "Open Sans"),
        tickformat = ".0%"
      ),
      xaxis = list(
        title = list(
          text = "Year",
          font = list(size = 16, color = "black", family = "Open Sans")
        ),
        tickfont = list(size = 12, color = "black", family = "Open Sans")
      ),
      margin = list(t = 80) 
    ) %>% 
    config(displayModeBar = FALSE)
  
  plot <- highlight(
    plot,
      on = "plotly_hover",
      off = "plotly_doubleclick",
      color = toRGB(transcend_cols[3]),  # Highlight color for the hovered line
      opacityDim = .7,              # Dim other lines when a line is highlighted
      persistent = FALSE,
    )
  
  return(plot)
}
```


```{r plot}
justice_dat <- prep_overall(dat, ed_justice, repeaters_3, tots_3)
fancy_across(justice_dat, "Figure 1. How Educational Justice practices in schools are growing over time")
```

### Deeper learning for mastery

Lorem ipsum odor amet, consectetuer adipiscing elit. Conubia class mauris cursus eros euismod primis purus congue. Hac iaculis adipiscing fames vel mattis nam mattis. Ac duis ad semper facilisis dictumst. Ridiculus lobortis mollis; aliquam viverra varius cras. Fermentum faucibus nostra quam cursus facilisi. Duis eros senectus posuere ridiculus rhoncus at aliquet aptent.  

Nisi lacinia semper volutpat laoreet penatibus libero venenatis. Feugiat vulputate inceptos fusce vitae ullamcorper ullamcorper? Interdum hendrerit vivamus gravida efficitur inceptos fermentum. Ultricies feugiat sapien proin dictum, faucibus semper potenti. Ac condimentum facilisi taciti semper sem; eu maximus torquent. Leo proin torquent dolor fermentum augue ex fermentum fusce? Justo blandit facilisis; posuere fringilla lacinia morbi. Justo a dapibus sodales ipsum quam natoque pretium dignissim.  

Eget quisque praesent risus a sed nam parturient enim. Lectus aptent porttitor dapibus lacinia magnis potenti, ultricies dictum. Netus litora mi aptent ligula, morbi nascetur consectetur in tempor. Dignissim felis hac penatibus nullam inceptos per suspendisse rhoncus. Enim libero sit lobortis lacinia feugiat urna. Sem dapibus auctor dapibus ultrices quam. Tincidunt sapien dis tortor pellentesque hac netus sollicitudin hac vehicula. Sed potenti pretium pulvinar interdum, volutpat lacus libero. Phasellus ultricies at inceptos convallis luctus lacus faucibus fames.  

Tristique curae semper auctor facilisi lectus in fermentum. Natoque venenatis donec sodales sapien primis quisque finibus. Tellus pulvinar duis viverra dui lobortis. Potenti luctus risus varius ultricies et vitae imperdiet. Praesent vitae porttitor porttitor pretium bibendum lorem ad. Orci facilisis nisl sollicitudin aliquam proin libero porta. Vel cursus sollicitudin amet ante id. Dolor conubia velit vivamus posuere; morbi cursus aptent eros. Penatibus mus mollis libero cras sociosqu interdum augue.  

```{r}
deep <- prep_overall(dat, deeper, repeaters_3, tots_3)
fancy_across(deep, "Figure 2. Changes in deeper learning cluster 2019-2024")
```

### Postsecondary pathways and the world outside school

Lorem ipsum odor amet, consectetuer adipiscing elit. Quis at eu platea praesent dictum varius convallis vehicula. Montes dolor mattis pellentesque blandit magnis pretium ad. Eros praesent habitant tempor aenean posuere at primis leo. Urna gravida volutpat etiam tristique quis? Mattis imperdiet facilisi curabitur velit ut mattis aliquam. Dictum semper convallis volutpat convallis sollicitudin blandit per laoreet dui. Sem fringilla curabitur posuere sodales fusce finibus. Iaculis egestas senectus molestie vehicula gravida in pulvinar.  

Ut nostra taciti senectus eu fringilla. Viverra malesuada sagittis sit tellus inceptos neque. Pellentesque euismod viverra quis luctus; dapibus nascetur sodales! Per parturient sit taciti tortor bibendum facilisis. Suspendisse vulputate magnis rutrum imperdiet dolor. Accumsan feugiat donec auctor egestas enim. Taciti malesuada dis quam tempus taciti potenti ligula posuere massa. Lectus vel ex sapien nec tortor tortor netus eleifend id. Vestibulum risus auctor vivamus consectetur vivamus aenean dignissim pellentesque volutpat. Efficitur conubia laoreet aliquet ullamcorper morbi ullamcorper.  

Praesent iaculis vel consectetur montes auctor luctus himenaeos. Mauris maximus malesuada bibendum odio finibus venenatis. Viverra tempor sem tincidunt eros sollicitudin. Nunc integer metus tempor consequat; fusce integer. Laoreet id cubilia fames mattis metus malesuada penatibus interdum. Nulla mi magnis vitae sapien facilisis molestie curae. Duis urna venenatis inceptos; dictumst ipsum montes placerat.  

```{r}
post_dat <- prep_overall(dat, postsecondary, repeaters_3, tots_3)
fancy_across(post_dat, "Changes in postsecondary pathways cluster 2019-2024")
```

### Individualized and blended learning

Ut nostra taciti senectus eu fringilla. Viverra malesuada sagittis sit tellus inceptos neque. Pellentesque euismod viverra quis luctus; dapibus nascetur sodales! Per parturient sit taciti tortor bibendum facilisis. Suspendisse vulputate magnis rutrum imperdiet dolor. Accumsan feugiat donec auctor egestas enim. Taciti malesuada dis quam tempus taciti potenti ligula posuere massa. Lectus vel ex sapien nec tortor tortor netus eleifend id. Vestibulum risus auctor vivamus consectetur vivamus aenean dignissim pellentesque volutpat. Efficitur conubia laoreet aliquet ullamcorper morbi ullamcorper.  

Praesent iaculis vel consectetur montes auctor luctus himenaeos. Mauris maximus malesuada bibendum odio finibus venenatis. Viverra tempor sem tincidunt eros sollicitudin. Nunc integer metus tempor consequat; fusce integer. Laoreet id cubilia fames mattis metus malesuada penatibus interdum. Nulla mi magnis vitae sapien facilisis molestie curae. Duis urna venenatis inceptos; dictumst ipsum montes placerat.  

```{r}
ind_dat <- prep_overall(dat, individualized, repeaters_3, tots_3)
fancy_across(ind_dat, "Changes in individualized learning cluster 2019-2024")
```

Lorem ipsum odor amet, consectetuer adipiscing elit. Quis at eu platea praesent dictum varius convallis vehicula. Montes dolor mattis pellentesque blandit magnis pretium ad. Eros praesent habitant tempor aenean posuere at primis leo. Urna gravida volutpat etiam tristique quis? Mattis imperdiet facilisi curabitur velit ut mattis aliquam. Dictum semper convallis volutpat convallis sollicitudin blandit per laoreet dui. Sem fringilla curabitur posuere sodales fusce finibus. Iaculis egestas senectus molestie vehicula gravida in pulvinar.    

>**An important methodological note:** In 2023, we restructured how blended learning practices are displayed in the survey. Instead of displaying “blended learning” and the five models side by side, which we had done in the 2019-2022 surveys, we showed respondents the “blended learning” practice first, then asked a follow-up question about the five models only to respondents who reported implementing blended learning. (Since the models are all ways of implementing blended learning, we decided to “nest” them underneath blended learning in this way.) We carefully considered whether this structural change in the survey could explain the decreased reporting of blended learning models in 2023. To check for this, we analyzed individual responses from schools that responded to the survey in 2023 (when we made the change), as well as in prior years, to see if their 2023 responses were notably different from past surveys. We did not find notable reporting differences among repeat-responder schools, which convinced us that the change to the survey structure did not contribute significantly to the changes we observed in schools’ survey responses. Furthermore, we made the same structural change in the survey with two other groups of practices (co-leadership and alternative and non-traditional assessments), and did not see uniform declines in schools reporting those practices the way we did with blended learning models. We concluded that the declines in blended learning models do likely have a basis in reality — in other words, the declines we saw in schools reporting blended learning models likely represent what schools are actually implementing.

## B. Pandemic interruptions to schools' reported practices

Lorem ipsum odor amet, consectetuer adipiscing elit. Cras dictum diam montes consequat tellus ad. Varius sem nibh commodo, ultricies consectetur nisi maecenas taciti non. Lobortis tempus lectus nunc porttitor, nostra praesent natoque sollicitudin. Finibus tristique interdum sapien litora sociosqu mus nisi. Fermentum fames montes pretium sed duis per. Urna felis eleifend efficitur eget bibendum curabitur. Ultrices magnis rhoncus torquent a donec inceptos gravida commodo.  

Quam consequat pharetra penatibus molestie dapibus elit fusce dolor arcu! Nec natoque vel primis maximus feugiat elit. Curae efficitur adipiscing vel, faucibus vehicula libero ultricies. Libero ullamcorper semper non vehicula lectus sit duis porta. Vestibulum purus ante phasellus etiam himenaeos conubia donec primis. Elit venenatis tristique himenaeos dignissim condimentum duis in scelerisque. Nullam vulputate pellentesque lorem lectus lorem elit velit nascetur.  

Sem est enim ex urna suspendisse rutrum. Est nulla congue eleifend donec integer phasellus posuere euismod. Luctus euismod ac magna ullamcorper phasellus penatibus lectus varius. Natoque fusce quam placerat interdum habitant orci id. Massa suspendisse etiam vitae habitant lacinia congue tempor? Quis proin litora fermentum in viverra nunc dapibus accumsan. Per curae tempus elementum pretium suscipit curae lacus. Fringilla ornare maecenas sit volutpat magnis lorem nec.  

```{r}
# Pulled from Gregor's code and modified - schools-practices-over-time
# Run model
wide <- import(here("data", "longitudinal/tags-wide.csv"))
volatility_data = 
  wide |>
  filter(n() > 1, .by = school_id) |>
  arrange(school_id, year) |>
  mutate(
    i_seq = row_number(),
    transition = case_when(
      i_seq == 1 ~ NA_character_,
      lag(year) >= 2022 ~ 'post_covid',
      year == 2021 ~ 'to_covid',
      lag(year) == 2021 ~ 'from_covid',
      year > 2021 & lag(year) == 2019 ~ 'skip_covid',
      .default = "PROBLEM"
    ),
    across(
      .cols = starts_with("practices"),
      \(x) c(0, abs(diff(x))) 
      # ^^^
      # take absolute difference from prev row
      # stick 0 on the front for first row
      # NAs (when tags weren't in use) will stay as NAs
    ),
    n_changes = rowSums(across(.cols = starts_with("practices")), na.rm = TRUE),
    .by = school_id
  ) |>
  filter(i_seq > 1) |> 
  select(!starts_with("practices"))

add_only_volatility = 
  wide |>
  filter(n() > 1, .by = school_id) |>
  arrange(school_id, year) |>
  mutate(
    i_seq = row_number(),
    transition = case_when(
      i_seq == 1 ~ NA_character_,
      lag(year) >= 2022 ~ 'post_covid',
      year == 2021 ~ 'to_covid',
      lag(year) == 2021 ~ 'from_covid',
      year > 2021 & lag(year) == 2019 ~ 'skip_covid',
      .default = "PROBLEM"
    ),
    across(
      .cols = starts_with("practices"),
      \(x) c(0, pmax(diff(x), 0)) 
      # ^^^
      # pmax instead of abs value to count only adds
      # NAs (when tags weren't in use) will stay as NAs
    ),
    n_changes = rowSums(across(.cols = starts_with("practices")), na.rm = TRUE),
    .by = school_id
  ) |>
  filter(i_seq > 1) |> 
  select(!starts_with("practices"))
## get demographics
xx = read_csv(here("data/longitudinal/combined-dat-ip.csv"))
xx = xx |>
  mutate(
    stu_poc_pct = 1 - self_reported_race_white,
  ) |>
  select(
    school_id,
    year = panel_year, 
    total_enroll = self_reported_total_enrollment,
    stu_poc_pct,
    locale, 
    school_descriptor,
    starts_with("grades")
  ) |>
  mutate(
    enroll_scaled = (total_enroll - mean(total_enroll, na.rm = TRUE)) / 
      sd(total_enroll, na.rm = TRUE),
    stu_poc_pct_scaled = (stu_poc_pct - mean(stu_poc_pct, na.rm = TRUE)) /
      sd(stu_poc_pct, na.rm = TRUE),
    locale = relevel(factor(locale), ref = "Urban"),
    school_descriptor = factor(
      school_descriptor,
      levels = c(1, 2, 3),
      labels = c("District", "Charter", "Private")
    ) 
  )

mm_vol = left_join(volatility_data, xx, by = c("school_id", "year"))
mm_add = left_join(add_only_volatility, xx, by = c("school_id", "year"))

mm_vol = mm_vol |>
  mutate(transition = relevel(factor(transition), ref = "post_covid"))
mm_add = mm_add |>
  mutate(transition = relevel(factor(transition), ref = "post_covid"))


missing_count =  mm_vol |> 
  is.na() |> 
  colSums() |> 
  sort(decreasing = TRUE) |> 
  data.frame(n_missing = _)
vol_mod = lm(
  n_changes ~ transition + stu_poc_pct_scaled + enroll_scaled + locale + school_descriptor +
     grades_elementary + grades_middle + grades_high,
  data = mm_vol
)
```

```{r}
# Extract coeffs
vol_coef = broom::tidy(vol_mod) |>
  arrange(desc(estimate)) |>
  mutate(term = fct_inorder(term),
         term = case_when(
           term == "transitionskip_covid" ~ "Excluding COVID",
           term == "transitionto_covid" ~ "Transition to COVID",
           term == "(Intercept)" ~ "Baseline",
           term == "transitionfrom_covid" ~ "Transition from COVID",
           term == "localeRural" ~ "Rural",
           term == "grades_elementary" ~ "Elementary schools",
           term == "localeMultiple" ~ "Multiple geographic locales",
           term == "enroll_scaled" ~ "Enrollment size",
           term == "school_descriptorPrivate" ~ "Private (independent) school",
           term == "school_descriptorCharter" ~ "Public charter school",
           term == "stu_poc_pct_scaled" ~ "% BIPOC students",
           term == "localeSuburban" ~ "Suburban",
           term == "grades_high" ~ "High schools",
           term == "grades_middle" ~ "Middle schools"
         )) 
```

```{r}
# Pull baseline to center in plot
intercept <- vol_coef %>% filter(term == "Baseline") %>% pull(estimate)
# Adjust coefficients around baseline
plot_dat <- vol_coef %>% 
  mutate(
    deviation = estimate - intercept,
    sig = ifelse(p.value < .05, "yes", "no")
  ) %>% 
  filter(term != "Baseline")
# Build plot
ggplot(plot_dat, aes(y = reorder(term, -estimate), x = deviation, fill = sig)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c(
    "no" = transcend_na,
    "yes" = transcend_cols[1]
  )) +
  scale_x_continuous(limits = c(-8, 10), expand = expansion()) +
  labs(
    x = "Estimated number of practices added or dropped",
    y = "",
    title = str_wrap("Estimated effect on number of practices modified by schools between survey responses", 55),
    subtitle = str_wrap("Bars in blue indicate a statistically significant relationship. The baseline is set at 0.", 75)
  ) +
  theme(
    panel.grid.major.y = element_blank(),
    legend.position= "none"
  ) 
```

Praesent iaculis vel consectetur montes auctor luctus himenaeos. Mauris maximus malesuada bibendum odio finibus venenatis. Viverra tempor sem tincidunt eros sollicitudin. Nunc integer metus tempor consequat; fusce integer. Laoreet id cubilia fames mattis metus malesuada penatibus interdum. Nulla mi magnis vitae sapien facilisis molestie curae. Duis urna venenatis inceptos; dictumst ipsum montes placerat.  

```{r }
#read in data
long = import(here("data/longitudinal", "tags-long.csv"))
#get vector of 4-year tags
tags_4y = long |>
  filter(usage == 1) |>
  filter(n_distinct(year) >= 4, .by = var) |>
  pull(var) |>
  unique()
long_4y = long |> filter(var %in% tags_4y)
#get schools
sch = import(here("data/long_school.csv")) |>
  summarize(n_years = n_distinct(year), .by = c(school_id, school_name))
## append 2024 schools - G's temp fix
sch = long |>
  summarize(
    n_years = n_distinct(year),
    .by = school_id
  ) |>
  left_join(
    select(sch, school_id, school_name)
  )

potential_wafflers = long_4y |>
  distinct(school_id, year) |>
  filter(n_distinct(year) >= 3, .by = school_id) |>
  summarize(
    years = toString(year),
    could_covid_waffle = 2019 %in% year & 2021 %in% year,
    could_waffle_2022 = 2021 %in% year & 2022 %in% year,
    could_waffle_2023 = 2022 %in% year & 2023 %in% year,
    could_waffle_2024 = 2023 %in% year & 2024 %in% year,
    .by = school_id
  )

waffle_denom = potential_wafflers |>
  summarize(across(starts_with("could"), sum))

waffle_all = long_4y |>
  filter(
    1 %in% usage,    ## present at least once
    n() > 2,         ## at least 3 survey responses
    .by = c(var, school_id)
  ) |> 
  mutate(
    added = any(diff(usage) == 1),
    dropped = any(diff(usage) == -1),
    all_1 = all(usage == 1),
    waffled = added & dropped,
    waffle_bump = waffled & last(usage, na_rm = TRUE) == 0,
    waffle_dip = waffled & last(usage, na_rm = TRUE) == 1,
    .by = c(var, school_id)
  ) |>
  pivot_wider(names_from = year, values_from = usage) |>
  left_join(sch, by = "school_id") |>
  select(school_id, school_name, tag = var, `2019`:`2024`, added, dropped, all_1, starts_with("waffle")) |>
  arrange(school_id, desc(waffled)) |>
  mutate(
    binary_summary = paste(`2019`, `2021`, `2022`, `2023`, `2024`, sep = ","),
    waffle_type = case_when(
      `2019` == 0 & `2021` == 1 & waffled ~ "COVID bump",
      `2019` == 1 & `2021` == 0 & waffled ~ "COVID dip",
      `2021` == 0 & `2022` == 1 & waffled ~ "2022 bump",
      `2021` == 1 & `2022` == 0 & waffled ~ "2022 dip",
      `2022` == 0 & `2023` == 1 & waffled ~ "2023 bump",
      `2022` == 1 & `2023` == 0 & waffled ~ "2023 dip",
      `2023` == 0 & `2024` == 1 & waffled ~ "2024 bump",
      `2023` == 1 & `2024` == 0 & waffled ~ "2024 dip"
    )
  )
wafflers = long_4y |>
  ## keep only school/tag combos with at least 3 years
  filter(n_distinct(year) >= 3, .by = c(school_id, var)) |>
  arrange(school_id, var, year) |> 
  mutate(
    diff = c(NA, diff(usage)),
    .by = c(school_id, var)
  ) |>
  summarize(
    usage_string = paste(usage, collapse = ""),
    diff_string = paste(diff[-1], collapse = ""),
    year_string = paste(year, collapse = ", "),
    is_waffle = -1 %in% diff & 1 %in% diff,
    is_dip = is_waffle & which.min(diff) < which.max(diff),
    is_bump = is_waffle & which.max(diff) < which.min(diff),
    dip_years = if(is_dip) list(year[usage == 0]) else list(NULL),
    bump_years = if(is_bump) list(year[usage == 1]) else list(NULL),
    waffle_years = coalesce(dip_years, bump_years),
    potential_years = list(tail(head(year, -1), -1)),
    is_multi_waffle = sum(diff == 1, na.rm = TRUE) > 1 | sum(diff == -1, na.rm = TRUE) > 1,
    .by = c(school_id, var)
  )

waffle_summary = wafflers |>
  filter(!is_multi_waffle) |>
  unnest(potential_years) |>
  mutate(waffle_this_year = potential_years %in% waffle_years, 
         .by = c(school_id, var, potential_years)) |>
  summarize(
    waffle_possible = n(),
    waffle_count = sum(waffle_this_year),
    bump_count = sum(waffle_this_year & is_bump),
    dip_count = sum(waffle_this_year & is_dip),
    waffle_pct = mean(waffle_this_year),
    n_sch = n_distinct(school_id),
    waffle_per_sch = waffle_count / n_sch,
    .by = potential_years
  )

# Build plot
ggplot(waffle_summary, aes(factor(potential_years), waffle_per_sch)) +
  geom_segment(aes(
                   xend = factor(potential_years),
                   y = 0, 
                   yend = waffle_per_sch), 
                   color = transcend_cols[1]) +
  geom_point(size = 5, color = transcend_cols[3]) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 4)) +
  labs(x = "", 
       y = "Average waffles per school", 
       title = "Average waffles per school from 2021-2023") +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())
```

Lorem ipsum odor amet, consectetuer adipiscing elit. Dis ipsum dapibus varius enim efficitur sapien bibendum dui porta. Metus fames nisl penatibus feugiat id litora fames. Consectetur facilisis porta nunc mi potenti, nascetur proin. Lorem vitae natoque, facilisis nisi nulla facilisis vel curabitur? Tellus dis senectus erat praesent penatibus vel mauris quis aptent. Etiam egestas magna sagittis nibh habitant sed.