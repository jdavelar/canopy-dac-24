---
title: "Preliminary Investigation"
author: "Janette Avelar"
date: '2023-09-22'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(rio)
dat_19 <- import(here("data", "canopy-2019-2021.rds"))
load("data/complete_canopy_2022.RData")
dat_22 <- clean_data_full
load("data/complete_canopy_2023.RData")
dat_23 <- full
```

# Deep dive into high-participation schools

For the following analysis, I identified the schools across our dataset that participated all 4 years. I've created a new dataset comprised solely of tag selection, and will investigate these.

```{r merge school participation data}
#ID which schools participated all 4 years
#Export ID list to merge with tags

#step 1 - create 0/1 participation for 2019 & 2021
schools_19 <- dat_19 %>% 
  select(year, school_id) %>% 
  mutate(rate = rep(1, nrow(.))) %>% 
  pivot_wider(names_from = year,
              values_from = rate) %>% 
  mutate(`2021` = case_when(
    `2020` == 1 ~ 1,
    `2021` == 1 ~ 1,
    TRUE ~ 0
  )) %>% 
  select(!`2020`)
#step 2 - create 0/1 participation for 2022
schools_22 <- dat_22 %>% 
  select(school_id) %>%
  mutate(school_id = as.character(school_id)) %>% 
  mutate(`2022` = rep(1, nrow(.)))
#step 3 - create 0/1 participation for 2023
schools_23 <- dat_23 %>% 
  select(school_id) %>% 
  mutate(school_id = as.character(school_id)) %>% 
  mutate(`2023` = rep(1, nrow(.)))
#merge
schools <- schools_19 %>% 
  full_join(schools_22, by = "school_id") %>% 
  full_join(schools_23, by = "school_id") %>% 
  mutate(across(where(is.numeric), coalesce, 0))
export(schools, "data/school_participation.csv")
```

Looks like there are 492 distinct schools. Previous analysis had 542 - I think it was not de-duped?  
Check numbers:
*173 schools in 2019 (confirmed)  
*232 schools in 2021 (confirmed - pulled full list [331] & de-duped)  
*161 schools in 2022 (confirmed)  
*251 schools in 2023 (confirmed)  

817 obs over 492 distinct schools = At least 325 of these observations are repeat obs. A total of 29 schools participated all 4 years. (This is higher than what I calculated before - I found the error is coming from inconsistencies in school name generating higher counts. For example, the school ID will stay the same but the school name may be capitalized one year, and not the next.)

```{r ID high participation schools}
dat <- import(here("data", "school_participation.csv")) %>% 
  rowwise() %>% 
  mutate(ttl_part = sum(c(`2019`, `2021`, `2022`, `2023`))
  ) %>% 
  filter(ttl_part == 4) %>% 
  select(school_id)
```

Merge tag data with participation

```{r high participation tag merge}

```

N's years of participation

Looks like 210/492 schools have at least 2 data points - this is about 40% of our data. I'm not sure I understand the question about "how many schools 
*could* we have." We could have all 492 schools with full participation? It depends entirely on who ends up responding, which makes *me* think that we should prioritize the half of our sample that we only have 1 data point for, but others may think otherwise.

```{r summarized years of participation}
import(here("data", "school_participation.csv")) %>% 
  rowwise() %>% 
  mutate(ttl_part = sum(c(`2019`, `2021`, `2022`, `2023`))) %>% 
  ungroup() %>% 
  mutate(rate = rep(1, nrow(.))) %>% 
  group_by(ttl_part) %>% 
  summarize(n = sum(rate, na.rm = TRUE))
```

# Priority Nominators List

I generated the list below by generating a list of potential priority schools, defined as those schools that have participated 3+ times. I then extracted the list of their nominating organizations.

```{r priority 3+ schools}
#first extract school names
school_names_19 <- dat_19 %>% 
  select(school_id, school_name)
school_names_22 <- dat_22 %>% 
  select(school_id, school_name) %>% 
  mutate(school_id = as.character(school_id))
school_names_23 <- dat_23 %>% 
  select(school_id, school_name) %>% 
  mutate(school_id = as.character(school_id))
#merge
school_names <- school_names_19 %>% 
  full_join(school_names_22, by = c("school_id", "school_name")) %>% 
  full_join(school_names_23, by = c("school_id", "school_name")) %>% 
  unique()
export(school_names, "data/school_names.csv")

#generate priority list
priority_a <- schools %>% 
  rowwise() %>% 
  mutate(total = sum(c(`2019`, `2021`, `2022`, `2023`))) %>% 
  filter(total == 3 | total == 4) %>% 
  #match with names
  left_join(school_names, by = "school_id") %>% 
  select(school_id, school_name) #there are additional obs introduced that I will manually sort out in sheets as I tie back to nominator
export(priority_a, "data/high-participation priority.csv")

# generate second priority list - low participation and not since 2019
priority_b <- import(here("data", "last-participation-2019.csv")) %>% 
  mutate(school_id = as.character(school_id)) %>% 
  left_join(school_names, by = "school_id")
export(priority_b, "data/low-participation priority.csv")
```

Second round of priority

Priority school groups:
A = Schools that have participated twice in the past, once in 2019 or 2021, and a second time in 2022 or 2023.
B = Schools that have participated at least twice since 2019 but not schools that have participated each year following initial nomination, since theyâ€™re likely to participate again.
C = Schools that have participated once, either in 2019 or 2021.
D = BIPOC-led schools that participated in 2022 and/or 2023.

```{r priority}
#bipoc link 22
bipoc_22 <- dat_22 %>% 
  select(school_id, bipoc = confidential_leadership_team_diversity) %>% 
  filter(bipoc == "75 - 100% people of color" |
           bipoc == "50 - 74% people of color") %>% 
  select(school_id)
#bipoc link 23
bipoc_23 <- dat_23 %>% 
  select(school_id, bipoc = leadership_diversity) %>% 
  filter(bipoc == 3 |
           bipoc == 4) %>% 
  select(school_id)
#priority
priority_schools <- import(here("data", "school_participation.csv")) %>% 
  rowwise() %>% 
  mutate(total = sum(c(`2019`, `2021`, `2022`, `2023`), na.rm = TRUE)) %>% 
  ungroup() %>% 
  mutate(a = case_when(
    total == 2 &
    (`2019` == 1 | `2021` == 1) &
    (`2022` == 1 | `2023` == 1) ~ 1,
    TRUE ~ 0
  ),
  b = case_when(
    total > 2 ~ 1,
    TRUE ~ 0 #need to manually compare nomination years for deprioritization
  ),
  c = case_when(
    total == 1 & `2019` == 1 ~ 1,
    total == 1 & `2021` == 1 ~ 1,
    TRUE ~ 0
  ),
  d = case_when(
    school_id %in% bipoc_22$school_id ~ 1,
    school_id %in% bipoc_23$school_id ~ 1,
    TRUE ~ 0
  ),
  any = case_when(
    a == 1 ~ 1,
    b == 1 ~ 1,
    c == 1 ~ 1,
    d == 1 ~ 1,
    TRUE ~ 0
  ))
export(priority_schools, "data/priority-schools.csv")
```

Below is a quick test to see feasibility/ease of merging priority schools to their associated nominating org. 

```{r test priority nom/school merge}
p_school <- import(here("data", "priority-schools.csv"))
p_nom <- import(here("data", "all_nominations.csv")) %>% 
  select(!`Nomination ID`) %>% 
  filter(`Nominator Org` != "") %>% 
  rename(survey = SurveyName,
         org = `Nominator Org`,
         school_id = `Canopy School ID`) %>% 
  mutate(survey = case_when(
    grepl("2023", survey) ~ 2023,
    grepl("2022", survey) ~ 2022,
    grepl("2019", survey) ~ 2019,
    TRUE ~ 2021
  ),
  school_id = as.numeric(school_id)) %>% 
  filter(!is.na(school_id))
#criteria 1
group_a <- p_school %>% 
  filter(a == 1) %>% 
  # select(school_id, `2019`, `2021`, `2022`, `2023`) %>% 
  # pivot_longer(cols = c(`2019`, `2021`, `2022`, `2023`),
  #              names_to = "year",
  #              values_to = "response")
  select(school_id) %>% 
  left_join(p_nom, by = "school_id")
#export(group_a, "data/test-priority-list.csv")
```

